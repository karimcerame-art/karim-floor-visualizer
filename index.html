<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Karim Floor Visualizer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f5f5f5;
  text-align: center;
}

header {
  background: #000;
  color: #fff;
  padding: 14px;
  font-weight: bold;
}

#container {
  max-width: 420px;
  margin: auto;
  padding: 15px;
}

canvas {
  width: 100%;
  border-radius: 14px;
  background: #ddd;
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  border-radius: 12px;
  border: none;
  font-size: 16px;
}

.black {
  background: #000;
  color: #fff;
}

.gray {
  background: #aaa;
  color: #fff;
}

#laminates {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 10px;
}

#laminates img {
  width: 100%;
  border-radius: 8px;
  border: 2px solid transparent;
}

#laminates img.selected {
  border-color: #000;
}
</style>
</head>

<body>

<header>Floor Visualizer</header>

<div id="container">

<input type="file" id="upload" accept="image/*" hidden>
<button class="black" onclick="upload.click()">Upload Photo</button>

<canvas id="canvas"></canvas>

<button id="chooseBtn" class="gray" disabled>Choose Laminate</button>

<div id="laminates"></div>

<button class="black" onclick="saveImage()">Save Result</button>

</div>

<script>
const upload = document.getElementById("upload");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const chooseBtn = document.getElementById("chooseBtn");
const laminatesDiv = document.getElementById("laminates");

let baseImage = new Image();
let floorMask = null;

upload.onchange = e => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    baseImage.onload = () => {
      canvas.width = baseImage.width;
      canvas.height = baseImage.height;
      ctx.drawImage(baseImage, 0, 0);
      detectFloor();
    };
    baseImage.src = reader.result;
  };
  reader.readAsDataURL(file);
};

function detectFloor() {
  // SIMPLE FLOOR HEURISTIC (OPEN SOURCE STYLE)
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  floorMask = ctx.createImageData(imgData);

  for (let i = 0; i < imgData.data.length; i += 4) {
    const y = Math.floor(i / 4 / canvas.width);
    const ratio = y / canvas.height;

    // bottom 45% = floor
    if (ratio > 0.55) {
      floorMask.data[i + 3] = 255;
    }
  }

  chooseBtn.disabled = false;
  chooseBtn.className = "black";
  loadLaminates();
}

function loadLaminates() {
  laminatesDiv.innerHTML = "";
  const files = [
    "laminates/10CI56580.png",
    "laminates/10CI52799.png",
    "laminates/10CI56582.png"
  ];

  files.forEach(src => {
    const img = new Image();
    img.src = src;
    img.onclick = () => applyLaminate(img);
    laminatesDiv.appendChild(img);
  });
}

function applyLaminate(texture) {
  ctx.drawImage(baseImage, 0, 0);

  const pattern = ctx.createPattern(texture, "repeat");
  ctx.fillStyle = pattern;

  const maskData = floorMask.data;
  for (let i = 0; i < maskData.length; i += 4) {
    if (maskData[i + 3] > 0) {
      const x = (i / 4) % canvas.width;
      const y = Math.floor(i / 4 / canvas.width);
      ctx.fillRect(x, y, 1, 1);
    }
  }
}

function saveImage() {
  const link = document.createElement("a");
  link.download = "karim-floor-result.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}
</script>

</body>
</html>
