<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Karim Floors Visualizer</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, sans-serif;
    background: #f5f5f5;
  }
  #container {
    width: 100%;
    height: 100%;
    position: relative;
  }
  canvas {
    width: 100%;
    height: 100%;
    display: block;
  }
  input { display:none; }
</style>
</head>

<body>
<div id="container">
  <canvas id="canvas"></canvas>
</div>

<input type="file" id="fileInput" accept="image/*" />

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const fileInput = document.getElementById("fileInput");

let baseImage = null;
let floorMask = null;
let currentLaminate = null;

// Resize canvas to container
function resize() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
  if (baseImage) draw();
}
window.addEventListener("resize", resize);
resize();

// ðŸ”¹ Called from iOS
window.openImagePicker = () => fileInput.click();

fileInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const img = new Image();
  img.onload = () => {
    baseImage = img;
    detectFloor();
  };
  img.src = URL.createObjectURL(file);
};

// ðŸ”¹ AI FLOOR DETECTION (CLOUD)
async function detectFloor() {
  draw(); // show image first

  // DEMO cloud endpoint (replace later)
  const response = await fetch(
    "https://hf.space/embed/akhaliq/segformer-floor/api/predict",
    {
      method: "POST",
      body: JSON.stringify({}),
      headers: { "Content-Type": "application/json" }
    }
  );

  // TEMP: fake mask until endpoint finalized
  floorMask = document.createElement("canvas");
  floorMask.width = baseImage.width;
  floorMask.height = baseImage.height;
  const mctx = floorMask.getContext("2d");

  // Simple bottom-area mask (placeholder)
  mctx.fillStyle = "white";
  mctx.fillRect(0, baseImage.height * 0.55, baseImage.width, baseImage.height * 0.45);

  draw();
}

// ðŸ”¹ Apply laminate automatically
window.applyLaminate = name => {
  currentLaminate = new Image();
  currentLaminate.onload = draw;
  currentLaminate.src = `laminates/${name}.jpg`;
};

function draw() {
  if (!baseImage) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Fit image
  const scale = Math.min(
    canvas.width / baseImage.width,
    canvas.height / baseImage.height
  );
  const w = baseImage.width * scale;
  const h = baseImage.height * scale;
  const x = (canvas.width - w)/2;
  const y = (canvas.height - h)/2;

  ctx.drawImage(baseImage, x, y, w, h);

  if (currentLaminate && floorMask) {
    ctx.save();
    ctx.globalCompositeOperation = "source-atop";
    ctx.drawImage(currentLaminate, x, y, w, h);
    ctx.restore();
  }
}
</script>
</body>
</html>
